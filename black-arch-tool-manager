#!/usr/bin/env bash
# -----------------------------
# CONFIG
# -----------------------------
TERM="kitty"
FAV_FILE="$HOME/.config/blackarch-tools-script/favorites.conf"
RECENT_FILE="$HOME/.config/blackarch-tools-script/recent.conf"
CONFIG_DIR="$(dirname "$FAV_FILE")"
RED=$'\033[31m'
GREEN=$'\033[32m'
YELLOW=$'\033[33m'
BLUE=$'\033[34m'
RESET=$'\033[0m'
INSTALLED_TOOLS="$HOME/.config/blackarch-tools-script/installed_tools.cache"
# Create config directory if it does not exist
if [[ ! -d "$CONFIG_DIR" ]]; then
  mkdir -p "$CONFIG_DIR"
fi
# Create favorites file if it does not exist
if [[ ! -f "$FAV_FILE" ]]; then
  touch "$FAV_FILE"
fi
# Create recent file if it does not exist
if [[ ! -f "$RECENT_FILE" ]]; then
  touch "$RECENT_FILE"
fi
generate_installed_tools_cache() {
  pacman -Qqe | grep -E "$(pacman -Sl "blackarch" | cut -d' ' -f2)" >$INSTALLED_TOOLS
}
generate_installed_tools_cache
# -----------------------------
# CATEGORY MAP
# -----------------------------
declare -A CATMAP=(
  ["blackarch-webapp"]="üåê Web Application"
  ["blackarch-fuzzer"]="üß™ Fuzzing"
  ["blackarch-scanner"]="üì° Scanners"
  ["blackarch-proxy"]="üï∏ Proxy"
  ["blackarch-windows"]="ü™ü Windows"
  ["blackarch-dos"]="üí£ DoS"
  ["blackarch-disassembler"]="üß© Disassembler"
  ["blackarch-sniffer"]="üëÇ Sniffers"
  ["blackarch-voip"]="üìû VoIP"
  ["blackarch-fingerprint"]="üÜî Fingerprinting"
  ["blackarch-networking"]="üåê Networking"
  ["blackarch-recon"]="üîé Reconnaissance"
  ["blackarch-cracker"]="üîì Cracking"
  ["blackarch-exploitation"]="üí• Exploitation"
  ["blackarch-spoof"]="üé≠ Spoofing"
  ["blackarch-ai"]="ü§ñ AI"
  ["blackarch-defensive"]="üõ° Defensive"
  ["blackarch-forensic"]="üïµÔ∏è Forensics"
  ["blackarch-crypto"]="üîê Crypto"
  ["blackarch-backdoor"]="üö™ Backdoors"
  ["blackarch-wireless"]="üì° Wireless"
  ["blackarch-automation"]="‚öô Automation"
  ["blackarch-radio"]="üìª Radio"
  ["blackarch-binary"]="üì¶ Binary"
  ["blackarch-packer"]="üß≥ Packers"
  ["blackarch-reversing"]="üß† Reverse Engineering"
  ["blackarch-mobile"]="üì± Mobile"
  ["blackarch-malware"]="‚ò£ Malware"
  ["blackarch-code-audit"]="üßæ Code Audit"
  ["blackarch-social"]="üë• Social Engineering"
  ["blackarch-honeypot"]="üçØ Honeypot"
  ["blackarch-misc"]="üì¶ Misc"
  ["blackarch-wordlist"]="üìú Wordlists"
  ["blackarch-decompiler"]="üîÅ Decompiler"
  ["blackarch-config"]="üõ† Config"
  ["blackarch-debugger"]="üêû Debugger"
  ["blackarch-bluetooth"]="üì∂ Bluetooth"
  ["blackarch-database"]="üóÑ Database"
  ["blackarch-automobile"]="üöó Automobile"
  ["blackarch-hardware"]="üîå Hardware"
  ["blackarch-nfc"]="üì≥ NFC"
  ["blackarch-tunnel"]="üöá Tunneling"
  ["blackarch-drone"]="üöÅ Drone"
  ["blackarch-unpacker"]="üì§ Unpacker"
  ["blackarch-firmware"]="üíæ Firmware"
  ["blackarch-keylogger"]="‚å® Keylogger"
  ["blackarch-stego"]="üñº Steganography"
  ["blackarch-anti-forensic"]="üï∂ Anti-Forensic"
  ["blackarch-ids"]="üö® IDS"
  ["blackarch-threat-model"]="üìä Threat Modeling"
  ["blackarch-gpu"]="üéÆ GPU"
  ["__FAVORITES__"]="‚≠ê Favorites"
  ["__SEARCH__"]="üîç Search All Tools"
  ["__RECENT__"]="üïò Recent Tools"
)
# -----------------------------
# HELPER FUNCTIONS
# -----------------------------
is_favorite() {
  grep -qx "$1" "$FAV_FILE" 2>/dev/null
}
is_installed() {
  [[ -f "$INSTALLED_TOOLS" ]] || generate_installed_tools_cache
  grep -qx "$1" "$INSTALLED_TOOLS"
}
toggle_favorite() {
  local TOOL="$1"
  if is_favorite "$TOOL"; then
    grep -vx "$TOOL" "$FAV_FILE" >"$FAV_FILE.tmp"
    mv "$FAV_FILE.tmp" "$FAV_FILE"
    notify-send "BlackArch Launcher" "Removed from favorites: $TOOL"
  else
    echo "$TOOL" >>"$FAV_FILE"
    notify-send "BlackArch Launcher" "Added to favorites: $TOOL"
  fi
}
install_tool() {
  local TOOL="$1"
  clear
  echo "${GREEN}Installing: $TOOL${RESET}"
  echo "================================"
  sudo pacman -S "$TOOL"
  echo
  echo "${GREEN}Installation complete!${RESET}"
  echo "Press Enter to continue..."
  read
  generate_installed_tools_cache
}
uninstall_tool() {
  local TOOL="$1"
  clear
  echo "${RED}Uninstalling: $TOOL${RESET}"
  echo "================================"
  sudo pacman -Rns "$TOOL"
  echo
  echo "${RED}Uninstallation complete!${RESET}"
  echo "Press Enter to continue..."
  read
  generate_installed_tools_cache
}
run_tool() {
  local TOOL="$1"
  # Update recent
  grep -v "^$TOOL\$" "$RECENT_FILE" >"$RECENT_FILE.tmp" 2>/dev/null
  echo "$TOOL" >>"$RECENT_FILE.tmp"
  tail -n 10 "$RECENT_FILE.tmp" >"$RECENT_FILE"
  rm -f "$RECENT_FILE.tmp"
  # Run in floating terminal
  hyprctl dispatch exec "[float;size 70% 70%;center] $TERM -e bash -c 'sudo $TOOL; echo; echo Press Enter to close; read'" >/dev/null 2>&1 &
}
open_terminal_with_command() {
  local TOOL="$1"
  # Update recent
  grep -v "^$TOOL\$" "$RECENT_FILE" >"$RECENT_FILE.tmp" 2>/dev/null
  echo "$TOOL" >>"$RECENT_FILE.tmp"
  tail -n 10 "$RECENT_FILE.tmp" >"$RECENT_FILE"
  rm -f "$RECENT_FILE.tmp"

  # Create a temporary script that will pre-fill the command
  local TEMP_SCRIPT=$(mktemp)
  cat >"$TEMP_SCRIPT" <<'SCRIPT_EOF'
#!/bin/bash
TOOL="$1"
# Print the command for the user to see
echo -e "\033[1;34m‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\033[0m"
echo -e "\033[1;34m‚ïë  Command ready - edit as needed        ‚ïë\033[0m"
echo -e "\033[1;34m‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\033[0m"
echo ""
# Use read with pre-filled input
read -e -i "sudo $TOOL" -p "‚ûú " COMMAND
# Execute the command if not empty
if [[ -n "$COMMAND" ]]; then
    eval "$COMMAND"
fi
echo ""
echo "Press Enter to close..."
read
SCRIPT_EOF
  chmod +x "$TEMP_SCRIPT"

  # Open terminal and run the script, then delete it
  hyprctl dispatch exec "[float;size 70% 70%;center] $TERM -e bash -c '$TEMP_SCRIPT \"$TOOL\"; rm -f $TEMP_SCRIPT'" >/dev/null 2>&1 &
}
# -----------------------------
# TOOL ACTION MENU
# -----------------------------
tool_action_menu() {
  local TOOL="$1"
  # Build menu options based on install status
  local MENU_OPTIONS=()
  if is_installed "$TOOL"; then
    MENU_OPTIONS+=("${GREEN}‚ñ∂${RESET} Run Tool")
    MENU_OPTIONS+=("${BLUE}‚ö°${RESET} Open Terminal (sudo $TOOL)")
    MENU_OPTIONS+=("${RED}‚úñ${RESET} Uninstall")
  else
    MENU_OPTIONS+=("${GREEN}‚¨á${RESET} Install")
  fi
  if is_favorite "$TOOL"; then
    MENU_OPTIONS+=("${YELLOW}‚òÖ${RESET} Remove from Favorites")
  else
    MENU_OPTIONS+=("${YELLOW}‚òÜ${RESET} Add to Favorites")
  fi
  MENU_OPTIONS+=("${BLUE}‚Ñπ${RESET} Open Package URL")
  while true; do
    ACTION=$(printf "%s\n" "${MENU_OPTIONS[@]}" | fzf \
      --ansi \
      --prompt="‚ñ∂ $TOOL - Select Action: " \
      --preview="pacman -Si $TOOL 2>/dev/null || echo 'Package info not available'" \
      --preview-window=right:60%:wrap \
      --height=100% \
      --border \
      --cycle \
      --reverse)
    [[ -z "$ACTION" ]] && return # ESC or empty ‚Üí go back
    case "$ACTION" in
    *"Run Tool"*)
      run_tool "$TOOL"
      return
      ;;
    *"Open Terminal"*)
      open_terminal_with_command "$TOOL"
      return
      ;;
    *"Install"*)
      install_tool "$TOOL"
      return
      ;;
    *"Uninstall"*)
      uninstall_tool "$TOOL"
      return
      ;;
    *"Add to Favorites"*)
      toggle_favorite "$TOOL"
      # Rebuild menu
      tool_action_menu "$TOOL"
      return
      ;;
    *"Remove from Favorites"*)
      toggle_favorite "$TOOL"
      # Rebuild menu
      tool_action_menu "$TOOL"
      return
      ;;
    *"Open Package URL"*)
      # Extract URL from package description
      URL=$(pacman -Si "$TOOL" 2>/dev/null | grep -i "^URL" | awk '{print $3}')
      if [[ -n "$URL" ]]; then
        xdg-open "$URL" &>/dev/null &
        notify-send "BlackArch Launcher" "Opening $TOOL homepage in browser"
      else
        notify-send "BlackArch Launcher" "No URL found for $TOOL"
      fi
      ;;
    esac
  done
}
# -----------------------------
# TOOLS MENU
# -----------------------------
tools_menu() {
  local TOOLS=("$@")
  if [[ ${#TOOLS[@]} -eq 0 ]]; then
    notify-send "BlackArch Launcher" "No tools in this category"
    return
  fi
  while true; do
    # Load favorites
    readarray -t FAVS <"$FAV_FILE"
    # Build menu items with ‚≠ê for favorites
    MENU_ITEMS=()
    # ===== Installed tools =====
    for t in "${TOOLS[@]}"; do
      if is_installed "$t"; then
        if is_favorite "$t"; then
          MENU_ITEMS+=("‚≠ê $t")
        else
          MENU_ITEMS+=("$t")
        fi
      fi
    done
    # ===== Uninstalled tools =====
    for t in "${TOOLS[@]}"; do
      if ! is_installed "$t"; then
        if is_favorite "$t"; then
          MENU_ITEMS+=("‚≠ê $t ${RED}[not installed]${RESET}")
        else
          MENU_ITEMS+=("$t ${RED}[not installed]${RESET}")
        fi
      fi
    done
    # Show fzf menu
    CHOICE=$(printf "%s\n" "${MENU_ITEMS[@]}" | fzf \
      --ansi \
      --prompt="‚ñ∂ Select Tool: " \
      --preview='
    pkg=$(echo {} | sed -E "s/^\x1B\[[0-9;]*m//g; s/^‚≠ê //; s/ \[not installed\]//")
    # Rebuild the title line with color
    if pacman -Qi "$pkg" &>/dev/null; then
        if [[ {} == ‚≠ê* ]]; then
            echo "‚≠ê $pkg"
        else
            echo "$pkg"
        fi
    else
        if [[ {} == ‚≠ê* ]]; then
            echo -e "‚≠ê $pkg \e[31m[not installed]\e[0m"
        else
            echo -e "$pkg \e[31m[not installed]\e[0m"
        fi
    fi
    echo
    pacman -Si "$pkg"
    ' \
      --preview-window=right:60%:wrap \
      --height=100% \
      --border \
      --cycle \
      --reverse)
    [[ -z "$CHOICE" ]] && break # ESC or empty ‚Üí go back
    TOOL="$(echo "$CHOICE" | sed 's/^‚≠ê //; s/ \[not installed\]//')"
    # Show action menu for the selected tool
    tool_action_menu "$TOOL"
    # Regenerate cache in case install/uninstall happened
    generate_installed_tools_cache
  done
}
# -----------------------------
# MAIN MENU
# -----------------------------
main_menu() {
  MENU=()
  KEYS=()
  for g in $(pacman -Sg | awk '/^blackarch-/ {print $1}' | sort -u); do
    [[ -n "${CATMAP[$g]}" ]] && MENU+=("${CATMAP[$g]}") && KEYS+=("$g")
  done
  MENU+=("${CATMAP[__FAVORITES__]}")
  KEYS+=("__FAVORITES__")
  MENU+=("${CATMAP[__RECENT__]}")
  KEYS+=("__RECENT__")
  MENU+=("${CATMAP[__SEARCH__]}")
  KEYS+=("__SEARCH__")
  CHOICE=$(printf "%s\n" "${MENU[@]}" | fzf \
    --ansi \
    --prompt="‚ñ∂ BlackArch Launcher: " \
    --height=100% \
    --border \
    --cycle \
    --reverse)
  [[ -z "$CHOICE" ]] && exit 0
  for i in "${!MENU[@]}"; do
    if [[ "${MENU[$i]}" == "$CHOICE" ]]; then
      key="${KEYS[$i]}"
      case "$key" in
      "__SEARCH__")
        readarray -t ALL_TOOLS < <(pacman -Sgg | grep blackarch | cut -d' ' -f2 | sort -u)
        tools_menu "${ALL_TOOLS[@]}"
        ;;
      "__RECENT__")
        if [[ -s "$RECENT_FILE" ]]; then
          readarray -t RECENT_TOOLS < <(tac "$RECENT_FILE")
          tools_menu "${RECENT_TOOLS[@]}"
        else
          notify-send "BlackArch Launcher" "No recent tools"
        fi
        ;;
      "__FAVORITES__")
        if [[ -s "$FAV_FILE" ]]; then
          readarray -t FAV_TOOLS <"$FAV_FILE"
          tools_menu "${FAV_TOOLS[@]}"
        else
          notify-send "BlackArch Launcher" "No favorite tools yet"
        fi
        ;;
      *)
        readarray -t CAT_TOOLS < <(pacman -Sg "$key" | awk 'NF>1 {print $2}')
        tools_menu "${CAT_TOOLS[@]}"
        ;;
      esac
      main_menu
      return
    fi
  done
}
# -----------------------------
# START
# -----------------------------
main_menu
